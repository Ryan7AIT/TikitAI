# RAG System Visual Diagrams

## ğŸ¨ Quick Visual Reference

### Component Diagram
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          RAG SYSTEM                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      CHAT ROUTER                             â”‚   â”‚
â”‚  â”‚  â€¢ Receives HTTP requests                                    â”‚   â”‚
â”‚  â”‚  â€¢ Authenticates users                                       â”‚   â”‚
â”‚  â”‚  â€¢ Saves to database                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                            â”‚
â”‚                         â–¼                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      RAG SERVICE                             â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚         ask_question() â† YOU ARE HERE!               â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Fetches language preference                       â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Invokes LangGraph pipeline                        â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  â€¢ Collects metrics                                  â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚                         â”‚                                    â”‚   â”‚
â”‚  â”‚                         â–¼                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚  â”‚              LANGGRAPH PIPELINE                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚                                                      â”‚   â”‚   â”‚
â”‚  â”‚  â”‚  START â†’ _retrieve() â†’ _generate() â†’ END           â”‚   â”‚   â”‚
â”‚  â”‚  â”‚           â”‚              â”‚                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚           â–¼              â–¼                          â”‚   â”‚   â”‚
â”‚  â”‚  â”‚       [Translate]    [Use LLM]                     â”‚   â”‚   â”‚
â”‚  â”‚  â”‚       [Search DB]    [Format]                      â”‚   â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                â”‚                â”‚                        â”‚
â”‚           â–¼                â–¼                â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚  TRANSLATOR  â”‚ â”‚ VECTOR STORE â”‚ â”‚     LLM      â”‚               â”‚
â”‚  â”‚   (Argos)    â”‚ â”‚   (Qdrant)   â”‚ â”‚(Gemini/Ollama)â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      RAG LOGGER                              â”‚   â”‚
â”‚  â”‚  â€¢ Logs to JSONL                                             â”‚   â”‚
â”‚  â”‚  â€¢ Captures translation details                              â”‚   â”‚
â”‚  â”‚  â€¢ Records metrics                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Request Flow (Detailed)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER   â”‚ "Comment Ã§a marche?"
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ POST /chat/
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CHAT ROUTER                        â”‚
â”‚  âœ“ Authenticate                     â”‚
â”‚  âœ“ Extract question                 â”‚
â”‚  âœ“ Get user workspace               â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ ask_question(q, workspace_id, user_id)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAG SERVICE: ask_question()        â”‚
â”‚  Step 1: Fetch language pref        â”‚
â”‚    â†“                                â”‚
â”‚    SELECT * FROM userpreference     â”‚
â”‚    WHERE user_id=1                  â”‚
â”‚    Result: 'fr' â†’ 'French'          â”‚
â”‚                                     â”‚
â”‚  Step 2: Invoke LangGraph           â”‚
â”‚    â†“                                â”‚
â”‚    State = {                        â”‚
â”‚      question: "Comment..."         â”‚
â”‚      workspace_id: 2                â”‚
â”‚      source_language: "fr"          â”‚
â”‚      language: "French"             â”‚
â”‚    }                                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ rag_graph.invoke(state)
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LANGGRAPH: _retrieve()             â”‚
â”‚                                     â”‚
â”‚  Step 1: Check static responses     â”‚
â”‚    â†“ (none found)                   â”‚
â”‚                                     â”‚
â”‚  Step 2: Translate                  â”‚
â”‚    â†“                                â”‚
â”‚    translate_text(                  â”‚
â”‚      "Comment Ã§a marche?",          â”‚
â”‚      source="fr",                   â”‚
â”‚      target="en"                    â”‚
â”‚    )                                â”‚
â”‚    â†’ "How does it work?"            â”‚
â”‚                                     â”‚
â”‚  Step 3: Search vector DB           â”‚
â”‚    â†“                                â”‚
â”‚    similarity_search(               â”‚
â”‚      query="How does it work?",     â”‚
â”‚      filter=workspace_id=2,         â”‚
â”‚      k=3                            â”‚
â”‚    )                                â”‚
â”‚    â†’ [doc1, doc2, doc3]             â”‚
â”‚                                     â”‚
â”‚  Step 4: Return                     â”‚
â”‚    â†“                                â”‚
â”‚    {                                â”‚
â”‚      context: [docs],               â”‚
â”‚      translated_question: "How...", â”‚
â”‚      retrieval_latency_ms: 450      â”‚
â”‚    }                                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ State updated with docs
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LANGGRAPH: _generate()             â”‚
â”‚                                     â”‚
â”‚  Step 1: Format context             â”‚
â”‚    â†“                                â”‚
â”‚    context = """                    â”‚
â”‚      Here's what I know:            â”‚
â”‚      [doc1.content]                 â”‚
â”‚      [doc2.content]                 â”‚
â”‚    """                              â”‚
â”‚                                     â”‚
â”‚  Step 2: Create prompt              â”‚
â”‚    â†“                                â”‚
â”‚    prompt = f"""                    â”‚
â”‚      You are Aidly...               â”‚
â”‚      Context: {context}             â”‚
â”‚      Question: {question}           â”‚
â”‚      Reply in: French               â”‚
â”‚    """                              â”‚
â”‚                                     â”‚
â”‚  Step 3: Call LLM                   â”‚
â”‚    â†“                                â”‚
â”‚    llm.invoke(prompt)               â”‚
â”‚    â†’ "Ã‡a marche comme Ã§a..."        â”‚
â”‚                                     â”‚
â”‚  Step 4: Return                     â”‚
â”‚    â†“                                â”‚
â”‚    {                                â”‚
â”‚      answer: "Ã‡a marche...",        â”‚
â”‚      generation_latency_ms: 800     â”‚
â”‚    }                                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Return to ask_question()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  RAG SERVICE: Collect Metrics       â”‚
â”‚                                     â”‚
â”‚  metrics = {                        â”‚
â”‚    original_question: "Comment...", â”‚
â”‚    translated_question: "How...",   â”‚
â”‚    source_language: "fr",           â”‚
â”‚    response_language: "French",     â”‚
â”‚    was_translated: true,            â”‚
â”‚    retrieval_latency_ms: 450,       â”‚
â”‚    generation_latency_ms: 800,      â”‚
â”‚    ...                              â”‚
â”‚  }                                  â”‚
â”‚                                     â”‚
â”‚  return (answer, metrics)           â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ Return to router
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CHAT ROUTER: Save & Log            â”‚
â”‚                                     â”‚
â”‚  Step 1: Save to DB                 â”‚
â”‚    â†“                                â”‚
â”‚    INSERT INTO message (...)        â”‚
â”‚                                     â”‚
â”‚  Step 2: Log to JSONL               â”‚
â”‚    â†“                                â”‚
â”‚    rag_logger.log_interaction(      â”‚
â”‚      original_question="Comment...", â”‚
â”‚      translated_question="How...",  â”‚
â”‚      ...                            â”‚
â”‚    )                                â”‚
â”‚                                     â”‚
â”‚  Step 3: Return response            â”‚
â”‚    â†“                                â”‚
â”‚    {                                â”‚
â”‚      "answer": "Ã‡a marche...",      â”‚
â”‚      "latency_ms": 1250,            â”‚
â”‚      "message_id": 156              â”‚
â”‚    }                                â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ HTTP Response
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  USER   â”‚ Receives answer in French
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ§© LangGraph State Flow

```
Initial State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ question: "Comment Ã§a marche?"     â”‚
â”‚ original_question: "Comment..."    â”‚
â”‚ workspace_id: 2                    â”‚
â”‚ source_language: "fr"              â”‚
â”‚ language: "French"                 â”‚
â”‚ was_translated: true               â”‚
â”‚ translated_question: None          â”‚ â† Not set yet
â”‚ context: []                        â”‚ â† Empty
â”‚ answer: ""                         â”‚ â† Empty
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    _retrieve() runs
           â†“
After _retrieve():
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ question: "Comment Ã§a marche?"     â”‚
â”‚ original_question: "Comment..."    â”‚
â”‚ workspace_id: 2                    â”‚
â”‚ source_language: "fr"              â”‚
â”‚ language: "French"                 â”‚
â”‚ was_translated: true               â”‚
â”‚ translated_question: "How..."      â”‚ â† NOW SET! (Bug fix)
â”‚ context: [doc1, doc2, doc3]        â”‚ â† Documents added
â”‚ retrieval_latency_ms: 450          â”‚ â† Added
â”‚ answer: ""                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†“
    _generate() runs
           â†“
Final State:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ question: "Comment Ã§a marche?"     â”‚
â”‚ original_question: "Comment..."    â”‚
â”‚ workspace_id: 2                    â”‚
â”‚ source_language: "fr"              â”‚
â”‚ language: "French"                 â”‚
â”‚ was_translated: true               â”‚
â”‚ translated_question: "How..."      â”‚
â”‚ context: [doc1, doc2, doc3]        â”‚
â”‚ retrieval_latency_ms: 450          â”‚
â”‚ generation_latency_ms: 800         â”‚ â† Added
â”‚ answer: "Ã‡a marche comme Ã§a..."    â”‚ â† Answer generated!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ› The Bug (Before and After)

### BEFORE (Bug):
```
_retrieve() {
    search_question = translate("Comment...", "fr", "en")
    // search_question = "How does it work?"
    
    docs = search_vector_db(search_question)
    
    return {
        "context": docs,
        "retrieval_latency_ms": 450
        // âŒ NOT RETURNING translated_question!
    }
}

ask_question() {
    result = rag_graph.invoke(...)
    
    metrics = {
        "translated_question": result.get("translated_question")
        // Returns None! ğŸ˜­
    }
}

LOGS:
{
    "original_question": "Comment...",
    "translated_question": "Comment..."  â† SAME! (Bug)
}
```

### AFTER (Fixed):
```
_retrieve() {
    search_question = translate("Comment...", "fr", "en")
    // search_question = "How does it work?"
    
    docs = search_vector_db(search_question)
    
    return {
        "context": docs,
        "retrieval_latency_ms": 450,
        "translated_question": search_question  // âœ… NOW RETURNED!
    }
}

ask_question() {
    result = rag_graph.invoke(...)
    
    metrics = {
        "translated_question": result.get("translated_question")
        // Returns "How does it work?" âœ…
    }
}

LOGS:
{
    "original_question": "Comment...",
    "translated_question": "How does it work?"  â† DIFFERENT! âœ…
}
```

---

## ğŸ“Š Translation Flow

```
User Question
     â”‚
     â”‚ "Comment changer le superviseur?"
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Language Check     â”‚
â”‚  source_lang = "fr" â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Is it English?
       â–¼
    â”Œâ”€â”€NOâ”€â”
    â”‚     â”‚
    â–¼     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TRANSLATE      â”‚    â”‚   NO TRANSLATE   â”‚
â”‚                  â”‚    â”‚                  â”‚
â”‚ translate_text(  â”‚    â”‚ search_question  â”‚
â”‚   text="Comment",â”‚    â”‚   = question     â”‚
â”‚   source="fr",   â”‚    â”‚                  â”‚
â”‚   target="en"    â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ )                â”‚
â”‚                  â”‚
â”‚ â†’ "How to        â”‚
â”‚    change the    â”‚
â”‚    supervisor?"  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ Both paths merge
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SEARCH          â”‚
â”‚  Vector DB       â”‚
â”‚  (in English)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  GENERATE        â”‚
â”‚  (in user's      â”‚
â”‚   language)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Data Storage

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DATABASE (SQLite)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ UserPreference   â”‚      â”‚ User             â”‚           â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤           â”‚
â”‚  â”‚ id               â”‚      â”‚ id               â”‚           â”‚
â”‚  â”‚ user_id          â”‚â—„â”€â”€â”€â”€â”€â”‚ username         â”‚           â”‚
â”‚  â”‚ preference='lang'â”‚      â”‚ email            â”‚           â”‚
â”‚  â”‚ value='fr'       â”‚      â”‚ workspace_id     â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                     â”‚                       â”‚
â”‚                                     â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚                       â”‚
â”‚  â”‚ Conversation     â”‚              â”‚                       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚                       â”‚
â”‚  â”‚ id               â”‚              â”‚                       â”‚
â”‚  â”‚ title            â”‚              â”‚                       â”‚
â”‚  â”‚ user_id          â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚  â”‚ created_at       â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â”‚           â”‚                                                 â”‚
â”‚           â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                      â”‚
â”‚  â”‚ Message          â”‚                                      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                      â”‚
â”‚  â”‚ id               â”‚                                      â”‚
â”‚  â”‚ question         â”‚  â† Original question (any language) â”‚
â”‚  â”‚ answer           â”‚  â† Answer in user's language        â”‚
â”‚  â”‚ latency_ms       â”‚                                      â”‚
â”‚  â”‚ conversation_id  â”‚                                      â”‚
â”‚  â”‚ user_id          â”‚                                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 VECTOR STORE (Qdrant)                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Document Embeddings (in English)                          â”‚
â”‚                                                             â”‚
â”‚  [0.12, 0.45, -0.33, ...] â† "How to change supervisor"    â”‚
â”‚  [0.33, 0.21, -0.11, ...] â† "Zone configuration guide"    â”‚
â”‚  [0.44, 0.09, 0.22, ...]  â† "User management docs"        â”‚
â”‚                                                             â”‚
â”‚  + Metadata:                                               â”‚
â”‚    - workspace_id                                          â”‚
â”‚    - source file                                           â”‚
â”‚    - doc_id                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  LOG FILES (JSONL)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  logs/rag_interactions.jsonl                               â”‚
â”‚                                                             â”‚
â”‚  Line 1: {"timestamp": "...", "original_question": "..."}  â”‚
â”‚  Line 2: {"timestamp": "...", "original_question": "..."}  â”‚
â”‚  Line 3: {"timestamp": "...", "original_question": "..."}  â”‚
â”‚  ...                                                        â”‚
â”‚                                                             â”‚
â”‚  Each line = Complete interaction with:                    â”‚
â”‚  - Original question                                       â”‚
â”‚  - Translated question  â† NOW WORKING!                     â”‚
â”‚  - Retrieved docs                                          â”‚
â”‚  - Answer                                                  â”‚
â”‚  - All metrics                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Key Takeaways

### 1. Entry Point
```
ask_question() â† START HERE
```

### 2. The Pipeline
```
Language Detection â†’ Translation â†’ Search â†’ Generation â†’ Logging
```

### 3. The Bug Fix
```
_retrieve() now returns translated_question âœ…
```

### 4. Data Flow
```
User Input â†’ Database â†’ Translator â†’ Vector DB â†’ LLM â†’ Logger â†’ Response
```

### 5. What Gets Logged
```
âœ… Original question (any language)
âœ… Translated question (English)  â† Bug fix!
âœ… Source language code
âœ… Response language name
âœ… Retrieved documents
âœ… Latencies
âœ… Everything else
```

---

**Last Updated**: October 11, 2025  
**Purpose**: Visual reference for RAG system architecture  
**Status**: Bug Fixed! âœ…
