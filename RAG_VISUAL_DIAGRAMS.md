# RAG System Visual Diagrams

## ๐จ Quick Visual Reference

### Component Diagram
```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                          RAG SYSTEM                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                                       โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                      CHAT ROUTER                             โ   โ
โ  โ  โข Receives HTTP requests                                    โ   โ
โ  โ  โข Authenticates users                                       โ   โ
โ  โ  โข Saves to database                                         โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ                         โ                                            โ
โ                         โผ                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                      RAG SERVICE                             โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ   โ
โ  โ  โ         ask_question() โ YOU ARE HERE!               โ   โ   โ
โ  โ  โ  โข Fetches language preference                       โ   โ   โ
โ  โ  โ  โข Invokes LangGraph pipeline                        โ   โ   โ
โ  โ  โ  โข Collects metrics                                  โ   โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ   โ
โ  โ                         โ                                    โ   โ
โ  โ                         โผ                                    โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ   โ
โ  โ  โ              LANGGRAPH PIPELINE                      โ   โ   โ
โ  โ  โ                                                      โ   โ   โ
โ  โ  โ  START โ _retrieve() โ _generate() โ END           โ   โ   โ
โ  โ  โ           โ              โ                          โ   โ   โ
โ  โ  โ           โผ              โผ                          โ   โ   โ
โ  โ  โ       [Translate]    [Use LLM]                     โ   โ   โ
โ  โ  โ       [Search DB]    [Format]                      โ   โ   โ
โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ           โ                โ                โ                        โ
โ           โผ                โผ                โผ                        โ
โ  โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ               โ
โ  โ  TRANSLATOR  โ โ VECTOR STORE โ โ     LLM      โ               โ
โ  โ   (Argos)    โ โ   (Qdrant)   โ โ(Gemini/Ollama)โ              โ
โ  โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ โโโโโโโโโโโโโโโโ               โ
โ                                                                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ                      RAG LOGGER                              โ   โ
โ  โ  โข Logs to JSONL                                             โ   โ
โ  โ  โข Captures translation details                              โ   โ
โ  โ  โข Records metrics                                           โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ Request Flow (Detailed)

```
โโโโโโโโโโโ
โ  USER   โ "Comment รงa marche?"
โโโโโโฌโโโโโ
     โ
     โ POST /chat/
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CHAT ROUTER                        โ
โ  โ Authenticate                     โ
โ  โ Extract question                 โ
โ  โ Get user workspace               โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ ask_question(q, workspace_id, user_id)
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  RAG SERVICE: ask_question()        โ
โ  Step 1: Fetch language pref        โ
โ    โ                                โ
โ    SELECT * FROM userpreference     โ
โ    WHERE user_id=1                  โ
โ    Result: 'fr' โ 'French'          โ
โ                                     โ
โ  Step 2: Invoke LangGraph           โ
โ    โ                                โ
โ    State = {                        โ
โ      question: "Comment..."         โ
โ      workspace_id: 2                โ
โ      source_language: "fr"          โ
โ      language: "French"             โ
โ    }                                โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ rag_graph.invoke(state)
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  LANGGRAPH: _retrieve()             โ
โ                                     โ
โ  Step 1: Check static responses     โ
โ    โ (none found)                   โ
โ                                     โ
โ  Step 2: Translate                  โ
โ    โ                                โ
โ    translate_text(                  โ
โ      "Comment รงa marche?",          โ
โ      source="fr",                   โ
โ      target="en"                    โ
โ    )                                โ
โ    โ "How does it work?"            โ
โ                                     โ
โ  Step 3: Search vector DB           โ
โ    โ                                โ
โ    similarity_search(               โ
โ      query="How does it work?",     โ
โ      filter=workspace_id=2,         โ
โ      k=3                            โ
โ    )                                โ
โ    โ [doc1, doc2, doc3]             โ
โ                                     โ
โ  Step 4: Return                     โ
โ    โ                                โ
โ    {                                โ
โ      context: [docs],               โ
โ      translated_question: "How...", โ
โ      retrieval_latency_ms: 450      โ
โ    }                                โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ State updated with docs
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  LANGGRAPH: _generate()             โ
โ                                     โ
โ  Step 1: Format context             โ
โ    โ                                โ
โ    context = """                    โ
โ      Here's what I know:            โ
โ      [doc1.content]                 โ
โ      [doc2.content]                 โ
โ    """                              โ
โ                                     โ
โ  Step 2: Create prompt              โ
โ    โ                                โ
โ    prompt = f"""                    โ
โ      You are Aidly...               โ
โ      Context: {context}             โ
โ      Question: {question}           โ
โ      Reply in: French               โ
โ    """                              โ
โ                                     โ
โ  Step 3: Call LLM                   โ
โ    โ                                โ
โ    llm.invoke(prompt)               โ
โ    โ "รa marche comme รงa..."        โ
โ                                     โ
โ  Step 4: Return                     โ
โ    โ                                โ
โ    {                                โ
โ      answer: "รa marche...",        โ
โ      generation_latency_ms: 800     โ
โ    }                                โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ Return to ask_question()
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  RAG SERVICE: Collect Metrics       โ
โ                                     โ
โ  metrics = {                        โ
โ    original_question: "Comment...", โ
โ    translated_question: "How...",   โ
โ    source_language: "fr",           โ
โ    response_language: "French",     โ
โ    was_translated: true,            โ
โ    retrieval_latency_ms: 450,       โ
โ    generation_latency_ms: 800,      โ
โ    ...                              โ
โ  }                                  โ
โ                                     โ
โ  return (answer, metrics)           โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ Return to router
     โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CHAT ROUTER: Save & Log            โ
โ                                     โ
โ  Step 1: Save to DB                 โ
โ    โ                                โ
โ    INSERT INTO message (...)        โ
โ                                     โ
โ  Step 2: Log to JSONL               โ
โ    โ                                โ
โ    rag_logger.log_interaction(      โ
โ      original_question="Comment...", โ
โ      translated_question="How...",  โ
โ      ...                            โ
โ    )                                โ
โ                                     โ
โ  Step 3: Return response            โ
โ    โ                                โ
โ    {                                โ
โ      "answer": "รa marche...",      โ
โ      "latency_ms": 1250,            โ
โ      "message_id": 156              โ
โ    }                                โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
     โ
     โ HTTP Response
     โผ
โโโโโโโโโโโ
โ  USER   โ Receives answer in French
โโโโโโโโโโโ
```

---

## ๐งฉ LangGraph State Flow

```
Initial State:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ question: "Comment รงa marche?"     โ
โ original_question: "Comment..."    โ
โ workspace_id: 2                    โ
โ source_language: "fr"              โ
โ language: "French"                 โ
โ was_translated: true               โ
โ translated_question: None          โ โ Not set yet
โ context: []                        โ โ Empty
โ answer: ""                         โ โ Empty
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
    _retrieve() runs
           โ
After _retrieve():
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ question: "Comment รงa marche?"     โ
โ original_question: "Comment..."    โ
โ workspace_id: 2                    โ
โ source_language: "fr"              โ
โ language: "French"                 โ
โ was_translated: true               โ
โ translated_question: "How..."      โ โ NOW SET! (Bug fix)
โ context: [doc1, doc2, doc3]        โ โ Documents added
โ retrieval_latency_ms: 450          โ โ Added
โ answer: ""                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
           โ
    _generate() runs
           โ
Final State:
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ question: "Comment รงa marche?"     โ
โ original_question: "Comment..."    โ
โ workspace_id: 2                    โ
โ source_language: "fr"              โ
โ language: "French"                 โ
โ was_translated: true               โ
โ translated_question: "How..."      โ
โ context: [doc1, doc2, doc3]        โ
โ retrieval_latency_ms: 450          โ
โ generation_latency_ms: 800         โ โ Added
โ answer: "รa marche comme รงa..."    โ โ Answer generated!
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ The Bug (Before and After)

### BEFORE (Bug):
```
_retrieve() {
    search_question = translate("Comment...", "fr", "en")
    // search_question = "How does it work?"
    
    docs = search_vector_db(search_question)
    
    return {
        "context": docs,
        "retrieval_latency_ms": 450
        // โ NOT RETURNING translated_question!
    }
}

ask_question() {
    result = rag_graph.invoke(...)
    
    metrics = {
        "translated_question": result.get("translated_question")
        // Returns None! ๐ญ
    }
}

LOGS:
{
    "original_question": "Comment...",
    "translated_question": "Comment..."  โ SAME! (Bug)
}
```

### AFTER (Fixed):
```
_retrieve() {
    search_question = translate("Comment...", "fr", "en")
    // search_question = "How does it work?"
    
    docs = search_vector_db(search_question)
    
    return {
        "context": docs,
        "retrieval_latency_ms": 450,
        "translated_question": search_question  // โ NOW RETURNED!
    }
}

ask_question() {
    result = rag_graph.invoke(...)
    
    metrics = {
        "translated_question": result.get("translated_question")
        // Returns "How does it work?" โ
    }
}

LOGS:
{
    "original_question": "Comment...",
    "translated_question": "How does it work?"  โ DIFFERENT! โ
}
```

---

## ๐ Translation Flow

```
User Question
     โ
     โ "Comment changer le superviseur?"
     โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ  Language Check     โ
โ  source_lang = "fr" โ
โโโโโโโโฌโโโโโโโโโโโโโโโ
       โ
       โ Is it English?
       โผ
    โโโNOโโ
    โ     โ
    โผ     โผ
โโโโโโโโโโโโโโโโโโโโ    โโโโโโโโโโโโโโโโโโโโ
โ   TRANSLATE      โ    โ   NO TRANSLATE   โ
โ                  โ    โ                  โ
โ translate_text(  โ    โ search_question  โ
โ   text="Comment",โ    โ   = question     โ
โ   source="fr",   โ    โ                  โ
โ   target="en"    โ    โโโโโโโโโโโโโโโโโโโโ
โ )                โ
โ                  โ
โ โ "How to        โ
โ    change the    โ
โ    supervisor?"  โ
โโโโโโโโโโโโโโโโโโโโ
       โ
       โ Both paths merge
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ  SEARCH          โ
โ  Vector DB       โ
โ  (in English)    โ
โโโโโโโโโโโโโโโโโโโโ
       โ
       โผ
โโโโโโโโโโโโโโโโโโโโ
โ  GENERATE        โ
โ  (in user's      โ
โ   language)      โ
โโโโโโโโโโโโโโโโโโโโ
```

---

## ๐๏ธ Data Storage

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     DATABASE (SQLite)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  โโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ           โ
โ  โ UserPreference   โ      โ User             โ           โ
โ  โโโโโโโโโโโโโโโโโโโโค      โโโโโโโโโโโโโโโโโโโโค           โ
โ  โ id               โ      โ id               โ           โ
โ  โ user_id          โโโโโโโโ username         โ           โ
โ  โ preference='lang'โ      โ email            โ           โ
โ  โ value='fr'       โ      โ workspace_id     โ           โ
โ  โโโโโโโโโโโโโโโโโโโโ      โโโโโโโโโโโโโโโโโโโโ           โ
โ                                     โ                       โ
โ                                     โ                       โ
โ  โโโโโโโโโโโโโโโโโโโโ              โ                       โ
โ  โ Conversation     โ              โ                       โ
โ  โโโโโโโโโโโโโโโโโโโโค              โ                       โ
โ  โ id               โ              โ                       โ
โ  โ title            โ              โ                       โ
โ  โ user_id          โโโโโโโโโโโโโโโโ                       โ
โ  โ created_at       โ                                      โ
โ  โโโโโโโโโโฌโโโโโโโโโโ                                      โ
โ           โ                                                 โ
โ           โ                                                 โ
โ  โโโโโโโโโโผโโโโโโโโโโ                                      โ
โ  โ Message          โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโค                                      โ
โ  โ id               โ                                      โ
โ  โ question         โ  โ Original question (any language) โ
โ  โ answer           โ  โ Answer in user's language        โ
โ  โ latency_ms       โ                                      โ
โ  โ conversation_id  โ                                      โ
โ  โ user_id          โ                                      โ
โ  โโโโโโโโโโโโโโโโโโโโ                                      โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                 VECTOR STORE (Qdrant)                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  Document Embeddings (in English)                          โ
โ                                                             โ
โ  [0.12, 0.45, -0.33, ...] โ "How to change supervisor"    โ
โ  [0.33, 0.21, -0.11, ...] โ "Zone configuration guide"    โ
โ  [0.44, 0.09, 0.22, ...]  โ "User management docs"        โ
โ                                                             โ
โ  + Metadata:                                               โ
โ    - workspace_id                                          โ
โ    - source file                                           โ
โ    - doc_id                                                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  LOG FILES (JSONL)                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  logs/rag_interactions.jsonl                               โ
โ                                                             โ
โ  Line 1: {"timestamp": "...", "original_question": "..."}  โ
โ  Line 2: {"timestamp": "...", "original_question": "..."}  โ
โ  Line 3: {"timestamp": "...", "original_question": "..."}  โ
โ  ...                                                        โ
โ                                                             โ
โ  Each line = Complete interaction with:                    โ
โ  - Original question                                       โ
โ  - Translated question  โ NOW WORKING!                     โ
โ  - Retrieved docs                                          โ
โ  - Answer                                                  โ
โ  - All metrics                                             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ฏ Key Takeaways

### 1. Entry Point
```
ask_question() โ START HERE
```

### 2. The Pipeline
```
Language Detection โ Translation โ Search โ Generation โ Logging
```

### 3. The Bug Fix
```
_retrieve() now returns translated_question โ
```

### 4. Data Flow
```
User Input โ Database โ Translator โ Vector DB โ LLM โ Logger โ Response
```

### 5. What Gets Logged
```
โ Original question (any language)
โ Translated question (English)  โ Bug fix!
โ Source language code
โ Response language name
โ Retrieved documents
โ Latencies
โ Everything else
```

---

**Last Updated**: October 11, 2025  
**Purpose**: Visual reference for RAG system architecture  
**Status**: Bug Fixed! โ
